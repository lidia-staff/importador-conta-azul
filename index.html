<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Importador de Faturas → CSV do Conta Azul</title>

<!-- Tailwind (layout leve) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  window.pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
  .mono{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-6xl mx-auto p-6">
  <header class="mb-6">
    <h1 class="text-2xl md:text-3xl font-bold">Importador de Faturas → CSV do Conta Azul</h1>
    <p class="text-sm text-slate-600 mt-1">
      Stone (com OCR automático quando necessário) e Santander. Valores negativos, 10 colunas padrão Conta Azul.
    </p>
  </header>

  <!-- ALERT -->
  <div id="alert" class="hidden mb-4 rounded-lg border p-3 text-sm"></div>

  <!-- FORM -->
  <section class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">1) Fatura (PDF ou TXT)</label>
        <input id="file" type="file" accept=".pdf,.txt"
               class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" />
        <p id="fileName" class="text-xs text-slate-500 mt-1"></p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">2) Data de Vencimento (dd/mm/aaaa)</label>
        <input id="venc" type="text" placeholder="dd/mm/aaaa"
               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200" />
        <p class="text-xs text-slate-500 mt-1">O <b>ano</b> desta data será aplicado às compras.</p>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">3) Conta (Conta Azul)</label>
        <select id="conta"
                class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200">
          <option>Cartão de Crédito Stone</option>
          <option>Cartão de Crédito Santander</option>
        </select>
        <label class="inline-flex items-center gap-2 text-sm text-slate-600 mt-2 select-none">
          <input id="forceOCR" type="checkbox" class="accent-indigo-600">
          Forçar OCR (apenas se a fatura for escaneada / sem texto)
        </label>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">4) Centro de Custo</label>
        <input id="centro" type="text" value="Café"
               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200" />
      </div>
    </div>

    <div class="mt-4 flex gap-3">
      <button id="processBtn"
              class="px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50">
        Processar Fatura
      </button>
      <button id="exportBtn"
              class="px-4 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50"
              disabled>
        Exportar CSV
      </button>
    </div>
  </section>

  <!-- PREVIEW -->
  <section class="bg-white rounded-xl shadow-sm p-5">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Pré-visualização</h2>
      <span id="countTag" class="text-xs px-2 py-1 rounded-full bg-slate-100">0 lançamentos</span>
    </div>
    <div class="overflow-auto border rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
        <tr>
          <th class="text-left px-3 py-2">Competência</th>
          <th class="text-left px-3 py-2">Descrição</th>
          <th class="text-left px-3 py-2">Categoria</th>
          <th class="text-right px-3 py-2">Valor (R$)</th>
        </tr>
        </thead>
        <tbody id="tbody" class="divide-y"></tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-2">
      O CSV final contém as 10 colunas exigidas pelo Conta Azul; valores negativos; Centro de Custo = Café.
    </p>

    <details class="mt-4">
      <summary class="cursor-pointer text-sm text-slate-600">▼ Texto extraído (debug)</summary>
      <pre id="debugText" class="mt-2 text-xs bg-slate-50 p-3 rounded border overflow-auto mono"
           style="max-height:280px"></pre>
    </details>
  </section>
</div>

<script>
(function(){
  // ------------------ UI helpers ------------------
  const $ = (id) => document.getElementById(id);
  const alertBox = $('alert');
  function showAlert(msg, type='info'){
    alertBox.className = 'mb-4 rounded-lg border p-3 text-sm';
    if(type==='error') alertBox.className += ' bg-red-50 border-red-300 text-red-800';
    else if(type==='success') alertBox.className += ' bg-emerald-50 border-emerald-300 text-emerald-800';
    else alertBox.className += ' bg-slate-50 border-slate-300 text-slate-800';
    alertBox.textContent = msg;
    alertBox.classList.remove('hidden');
  }
  function hideAlert(){ alertBox.classList.add('hidden'); }

  // ------------------ Constantes ------------------
  const MESES = { jan:'01', fev:'02', mar:'03', abr:'04', mai:'05', jun:'06', jul:'07', ago:'08', set:'09', out:'10', nov:'11', dez:'12' };
  const HEADERS = [
    'Data de Competência',
    'Data de Vencimento',
    'Data de Pagamento',
    'Valor',
    'Categoria',
    'Descrição',
    'Cliente/Fornecedor',
    'CNPJ/CPF Cliente/Fornecedor',
    'Centro de Custo',
    'Observações'
  ];

  // ------------------ Funções util ------------------
  function normalize(s){ return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
  function getCategoria(desc){
    const d = normalize(desc);
    if(d.includes('seguro')) return 'Seguro de Imóveis';
    if(d.includes('canva') || d.includes('google') || d.includes('gsuite')) return 'Software / Licença de Uso';
    if(d.includes('magalu') || d.includes('geladeira')) return 'Eletrodomésticos';
    return 'Despesas a identificar';
  }
  function toNegBR(str){
    const cleaned = String(str).replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const v = parseFloat(cleaned);
    return -Math.abs(isFinite(v) ? v : 0);
  }
  function fmtBR(n){ return (n<0?'-':'') + Math.abs(n).toFixed(2).replace('.', ','); }
  function quoteCSV(val){
    const s = String(val ?? '');
    return (/[;"\n]/.test(s)) ? '"' + s.replace(/"/g,'""') + '"' : s;
  }
  function detectVencimento(text){
    let m = text.match(/VENCE\s+EM\s+(\d{2})\s+(JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ)\s+(\d{4})/i);
    if(m){ const mm = MESES[m[2].toLowerCase()]||'01'; return `${m[1]}/${mm}/${m[3]}`; }
    m = text.match(/Vencimento\D+(\d{2}\/\d{2}\/\d{4})/i);
    return m ? m[1] : '';
  }
  function detectConta(text){
    if(/stone/i.test(text)) return 'Cartão de Crédito Stone';
    if(/santander/i.test(text)) return 'Cartão de Crédito Santander';
    return $('conta').value;
  }
  function rowCA(dataComp, venc, valor, categoria, descricao, conta, centro){
    const centroFmt = (centro||'').trim() || 'Café';
    return {
      'Data de Competência': dataComp,
      'Data de Vencimento': venc,
      'Data de Pagamento': '',
      'Valor': fmtBR(valor),
      'Categoria': categoria,
      'Descrição': descricao,
      'Cliente/Fornecedor': '',
      'CNPJ/CPF Cliente/Fornecedor': '',
      'Centro de Custo': centroFmt,
      'Observações': ''
    };
  }

  // ------------------ Leitura de PDF ------------------
  async function pdfToLines(file){
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:ab, disableWorker:true}).promise;
    const lines=[];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent({ normalizeWhitespace:true, disableCombineTextItems:false });
      const buckets = new Map();
      for(const it of content.items){
        const y = Math.round(it.transform[5]);
        const x = Math.round(it.transform[4]);
        const arr = buckets.get(y) || [];
        arr.push({x, str: it.str});
        buckets.set(y, arr);
      }
      const ys = Array.from(buckets.keys()).sort((a,b)=>b-a);
      for(const y of ys){
        const arr = buckets.get(y).sort((a,b)=>a.x-b.x);
        const line = arr.map(o=>o.str).join(' ').replace(/\s{2,}/g,' ').trim();
        if(line) lines.push(line);
      }
      lines.push('');
    }
    return lines;
  }

  // OCR sob demanda (usado apenas se necessário ou se marcado “Forçar OCR”)
  async function runOCRLastPages(file, pagesBack=3){
    if(!window.Tesseract){
      await new Promise(res=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload=res; document.head.appendChild(s);
      });
    }
    const ab = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:ab, disableWorker:true}).promise;
    let text = '';
    const first = Math.max(1, pdf.numPages - pagesBack + 1);
    for(let p=first; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({ scale: 1.6 });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      const { data:{ text:ocr } } = await Tesseract.recognize(canvas, 'por');
      text += '\n' + ocr;
    }
    return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  function txtToLines(text){ return text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }

  // ------------------ Parsers ------------------
  function parseStone(linesAll, venc, conta, centro){
    const fix = s => String(s||'')
      .replace(/R\s*\$/g,'R$')
      .replace(/^(\d{1,2})([a-z]{3})/i,'$1 $2') // 1nov → 1 nov
      .replace(/\b2go\b/i,'ago').replace(/\b06ut\b/i,'out')
      .replace(/[—–]\s*/g,' - ').replace(/\s{2,}/g,' ').trim();
    const L0 = linesAll.map(fix);

    const ANO = (venc||'').slice(-4) || String(new Date().getFullYear());
    const reStart = /^LANÇAMENTOS DA FATURA\b/i;
    const reStop  = /^(ENCARGOS APLICÁVEIS À FATURA|OBRIGAÇÕES FUTURAS|RESUMO DA FATURA)/i;
    const reHeader= /^(LANÇAMENTOS|CARTÃO|OUTROS LANÇAMENTOS|DATA|DESCRIÇÃO|VALOR)\b/i;
    const reIgnore= /(Pagamento\s+feito)/i;

    // recorta seção
    let start = L0.findIndex(l=>reStart.test(l));
    if(start<0) start=0;
    let end = L0.slice(start+1).findIndex(l=>reStop.test(l));
    if(end<0) end=L0.length-start;
    const L = L0.slice(start, start+end+1);

    const reData  = /^(\d{1,2})\s+(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)\b/i;
    const reValor = /(?:R\$\s*)?([+-]?\d{1,3}(?:[.\s]?\d{3})*,\d{2})\b/;
    const reParc  = /Parcela\s+\d+\s+de\s+\d+/i;
    const out=[];

    for(let i=0;i<L.length;i++){
      const l = L[i];
      if(!l || reHeader.test(l) || reIgnore.test(l)) continue;

      const md = l.match(reData);
      if(!md) continue;

      const dd = md[1].padStart(2,'0');
      const mm = MESES[md[2].toLowerCase()] || '01';
      const dataComp = `${dd}/${mm}/${ANO}`;

      let descParts=[];
      const resto = l.slice(md.index+md[0].length).trim();
      if(resto) descParts.push(resto);
      if(reParc.test(L[i+1]||'')) descParts.push(L[i+1].trim());

      let valorMatch = l.match(reValor) || (L[i+1]&&L[i+1].match(reValor))
                     || (L[i+2]&&L[i+2].match(reValor)) || (L[i+3]&&L[i+3].match(reValor));

      // agrega linhas intermediárias para descrição
      let j=i+1;
      while(j<L.length && j<=i+3){
        const s=L[j];
        if(!s) { j++; continue; }
        if(reData.test(s) || reStop.test(s)) break;
        if(!reHeader.test(s) && !reIgnore.test(s)) descParts.push(s);
        j++;
      }

      if(!valorMatch) continue;
      const descricao = descParts.join(' ').trim();
      if(!descricao || reHeader.test(descricao) || reIgnore.test(descricao)) continue;

      const valor = toNegBR(valorMatch[1]);
      out.push(rowCA(dataComp, venc, valor, getCategoria(descricao), descricao, conta, centro));
      i = j-1;
    }
    return out;
  }

  function parseSantander(lines, venc, conta, centro){
    const out=[]; let inBlock=false;
    for(const l0 of lines){
      const l = String(l0||'').replace(/\s{2,}/g,' ').trim();
      if(/Trans[aã]coes?\s+Nacionais/i.test(l)){ inBlock=true; continue; }
      if(inBlock && /(Total em R\$|Total desta fatura)/i.test(l)) break;
      if(!inBlock) continue;

      const m = l.match(/(\d{2}-\d{2}-\d{4})\s+(.+?)\s+([Rr]\$?\s*[\d.\s]*\d+,\d{2}|\d+,\d{2})$/);
      if(m){
        const data = m[1].replace(/-/g,'/');
        const desc = m[2].trim();
        const valorNum = (m[3]||'').replace(/R\$\s*/i,'');
        out.push(rowCA(data, venc, toNegBR(valorNum), getCategoria(desc), desc, conta, centro));
      }
    }
    return out;
  }

  // ------------------ Estado / UI ------------------
  let rawText=''; let lines=[]; let rows=[];
  $('file').addEventListener('change', async ev=>{
    hideAlert(); rows=[]; renderTable([]);
    const f = ev.target.files[0]; if(!f) return;
    $('fileName').textContent = `Arquivo: ${f.name}`;

    try{
      if(f.type==='application/pdf' || f.name.toLowerCase().endsWith('.pdf')){
        // 1ª leitura: apenas texto nativo do PDF (sem OCR aqui)
        lines = await pdfToLines(f);
        rawText = lines.join('\n');
      }else{
        const txt = await f.text(); rawText = txt; lines = txtToLines(txt);
      }
      $('debugText').textContent = rawText.slice(0,8000);
      const autoVenc = detectVencimento(rawText); if(autoVenc) $('venc').value = autoVenc;
      $('conta').value = detectConta(rawText);
      showAlert('Arquivo carregado. Confira vencimento/conta e clique em "Processar Fatura".', 'success');
    }catch(err){
      console.error(err); showAlert('Erro ao ler o arquivo: '+err.message, 'error');
    }
  });

  $('processBtn').addEventListener('click', async ()=>{
    hideAlert(); rows=[]; renderTable([]);
    const venc = $('venc').value.trim();
    const conta= $('conta').value;
    const centro= $('centro').value.trim() || 'Café';
    const f = $('file').files[0];

    if(!rawText){ showAlert('Envie a fatura primeiro.', 'error'); return; }
    if(!/^\d{2}\/\d{2}\/\d{4}$/.test(venc)){ showAlert('Informe o vencimento no formato dd/mm/aaaa.', 'error'); return; }

    const tryParse = (whichLines) => {
      if(/stone/i.test(conta)) return parseStone(whichLines, venc, conta, centro);
      if(/santander/i.test(conta)) return parseSantander(whichLines, venc, conta, centro);
      const auto = detectConta(rawText);
      $('conta').value = auto;
      return /stone/i.test(auto) ? parseStone(whichLines, venc, auto, centro) : parseSantander(whichLines, venc, auto, centro);
    };

    let parsed = [];

    // Se usuário marcou "Forçar OCR", já vamos direto para OCR
    if($('forceOCR').checked && f && (f.type==='application/pdf' || f.name.toLowerCase().endsWith('.pdf'))){
      try{
        const ocrLines = await runOCRLastPages(f, 3);
        parsed = tryParse(ocrLines);
        rawText = ocrLines.join('\n');
        $('debugText').textContent = rawText.slice(0,8000);
      }catch(e){ console.error('OCR direto (forçado) falhou:', e); }
    } else {
      // Caso normal: tenta com texto nativo…
      parsed = tryParse(lines);

      // …se nada achar, cai para OCR (fallback)
      if(!parsed.length && f && (f.type==='application/pdf' || f.name.toLowerCase().endsWith('.pdf'))){
        try{
          const ocrLines = await runOCRLastPages(f, 3);
          if(ocrLines && ocrLines.length){
            parsed = tryParse(ocrLines);
            rawText = ocrLines.join('\n');
            $('debugText').textContent = rawText.slice(0,8000);
          }
        }catch(e){ console.error('OCR fallback error:', e); }
      }
    }

    if(!parsed.length){
      showAlert('Nenhum lançamento identificado. Use “Forçar OCR” apenas se a fatura for escaneada. Confira o “Texto extraído (debug)”.', 'error');
      $('exportBtn').disabled = true; 
      return;
    }

    rows = parsed; renderTable(rows); $('exportBtn').disabled = false;
    showAlert(`${rows.length} lançamentos identificados. Revise e exporte o CSV.`, 'success');
  });

  $('exportBtn').addEventListener('click', ()=>{
    if(!rows.length){ showAlert('Nada para exportar.', 'error'); return; }
    const csv = '\ufeff' + [
      HEADERS.join(';'),
      ...rows.map(r=>HEADERS.map(h=>quoteCSV(r[h]??'')).join(';'))
    ].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    const url = URL.createObjectURL(blob);
    const ts = new Date().toISOString().slice(0,10).replace(/-/g,'');
    a.href = url; a.download = `importacao_conta_azul_${ts}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  function renderTable(items){
    $('countTag').textContent = `${items.length} lançamento${items.length===1?'':'s'}`;
    const tb = $('tbody'); tb.innerHTML='';
    for(const r of items){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="px-3 py-2 text-xs">${r['Data de Competência']}</td>
        <td class="px-3 py-2 text-xs">${escapeHTML(r['Descrição']).slice(0,180)}</td>
        <td class="px-3 py-2 text-xs">${r['Categoria']}</td>
        <td class="px-3 py-2 text-xs text-right">${r['Valor']}</td>`;
      tb.appendChild(tr);
    }
  }
  function escapeHTML(s){ return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

})();
</script>
</body>
</html>

