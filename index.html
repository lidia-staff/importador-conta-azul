<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Importador de Faturas → CSV do Conta Azul</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- Tesseract (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>

  <style>
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-6xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold">Importador de Faturas → CSV do Conta Azul</h1>
      <p class="text-sm text-slate-600 mt-1">Stone (com OCR quando necessário) e Santander. Valores negativos; 10 colunas padrão Conta Azul.</p>
    </header>

    <div id="alert" class="hidden mb-4 p-3 rounded border text-sm"></div>

    <section class="bg-white shadow rounded-xl p-5 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">1) Fatura (PDF ou TXT)</label>
          <input id="file" type="file" accept=".pdf,.txt"
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-medium file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200"/>
          <p id="fileName" class="text-xs text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">2) Data de Vencimento (dd/mm/aaaa)</label>
          <input id="venc" type="text" placeholder="dd/mm/aaaa"
                 class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-indigo-200"/>
          <p class="text-xs text-slate-500 mt-1">O <b>ano</b> desta data será aplicado às compras.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">3) Conta (Conta Azul)</label>
          <select id="conta" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-indigo-200">
            <option>Cartão de Crédito Stone</option>
            <option>Cartão de Crédito Santander</option>
          </select>
          <label class="flex items-center gap-2 mt-2 text-sm">
            <input id="forceOcr" type="checkbox" class="h-4 w-4"/> Forçar OCR (apenas se a fatura for escaneada / sem texto)
          </label>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">4) Centro de Custo</label>
          <input id="centro" type="text" value="Café"
                 class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:ring-indigo-200"/>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="processBtn" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Processar Fatura</button>
        <button id="exportBtn" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700" disabled>Exportar CSV</button>
      </div>
    </section>

    <section class="bg-white shadow rounded-xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Pré-visualização</h2>
        <span id="countTag" class="text-xs px-2 py-1 rounded bg-slate-100">0 lançamentos</span>
      </div>
      <div class="overflow-auto border rounded">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="text-left px-3 py-2">Competência</th>
              <th class="text-left px-3 py-2">Descrição</th>
              <th class="text-left px-3 py-2">Categoria</th>
              <th class="text-right px-3 py-2">Valor (R$)</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
      <p class="text-xs text-slate-500 mt-2">O CSV final contém as 10 colunas exigidas pelo Conta Azul; valores negativos; Centro de Custo = Café.</p>

      <details class="mt-4">
        <summary class="cursor-pointer text-sm text-slate-600">▼ Texto extraído (debug)</summary>
        <textarea id="debug" class="w-full h-56 mt-2 p-2 border rounded mono text-xs"></textarea>
      </details>
    </section>
  </div>

  <script>
  (function(){
    // ---------- Utils ----------
    const $ = (id) => document.getElementById(id);
    const alertBox = $('alert');

    function showAlert(msg, type='info'){
      const styles = {
        info: 'border-slate-300 bg-slate-50 text-slate-800',
        error:'border-red-300 bg-red-50 text-red-800',
        ok:   'border-emerald-300 bg-emerald-50 text-emerald-800'
      };
      alertBox.className = 'mb-4 p-3 rounded border text-sm';
      alertBox.classList.add(...styles[type].split(' '));
      alertBox.textContent = msg;
      alertBox.classList.remove('hidden');
    }
    function hideAlert(){ alertBox.classList.add('hidden'); }

    const MESES = {jan:'01',fev:'02',mar:'03',abr:'04',mai:'05',jun:'06',jul:'07',ago:'08',set:'09',out:'10',nov:'11',dez:'12'};
    const HEADERS = [
      'Data de Competência','Data de Vencimento','Data de Pagamento','Valor','Categoria',
      'Descrição','Cliente/Fornecedor','CNPJ/CPF Cliente/Fornecedor','Centro de Custo','Observações'
    ];

    const CATEGORIAS = {
      'seguro':'Seguro de Imóveis',
      'canva':'Software / Licença de Uso',
      'google':'Software / Licença de Uso',
      'gsuite':'Software / Licença de Uso',
      'magalu':'Eletrodomésticos',
      'geladeira':'Eletrodomésticos',
      'leroy':'Despesas a identificar',
      'mercadolivre':'Despesas a identificar',
      'default':'Despesas a identificar'
    };

    function normalize(s){ return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase(); }
    function getCategoria(desc){
      const d = normalize(desc);
      for(const k in CATEGORIAS){ if(k!=='default' && d.includes(k)) return CATEGORIAS[k]; }
      return CATEGORIAS.default;
    }
    function toNegBR(str){
      const cleaned = String(str).replace(/R\$|\s/g,'').replace(/\./g,'').replace(',', '.');
      const v = parseFloat(cleaned);
      return -Math.abs(isFinite(v)?v:0);
    }
    function fmtBR(n){ return (n<0?'-':'')+Math.abs(n).toFixed(2).replace('.',','); }
    function quoteCSV(v){ const s=String(v??''); return /[;"\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s; }
    function anoFromVencimento(){ const v=$('venc').value.trim(); const m=v.match(/\d{2}\/\d{2}\/(\d{4})/); return m?+m[1]:(new Date()).getFullYear(); }

    function rowCA(dataComp, venc, valor, categoria, descricao, conta, centro){
      const centroFmt = (centro||'').trim().replace(/^cafe$/i,'Café') || 'Café';
      return {
        'Data de Competência': dataComp,
        'Data de Vencimento': venc,
        'Data de Pagamento': '',
        'Valor': fmtBR(valor),
        'Categoria': categoria,
        'Descrição': descricao,
        'Cliente/Fornecedor': '',
        'CNPJ/CPF Cliente/Fornecedor': '',
        'Centro de Custo': centroFmt,
        'Observações': ''
      };
    }

    function detectVencimento(text){
      let m = text.match(/VENCE\s+EM\s+(\d{2})\s+(JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ)\s+(\d{4})/i);
      if(m){ const mm = MESES[m[2].toLowerCase()]||'01'; return `${m[1]}/${mm}/${m[3]}`; }
      m = text.match(/Vencimento\D+(\d{2}\/\d{2}\/\d{4})/i);
      return m ? m[1] : '';
    }
    function detectConta(text){
      if(/stone/i.test(text)) return 'Cartão de Crédito Stone';
      if(/santander/i.test(text)) return 'Cartão de Crédito Santander';
      return $('conta').value;
    }

    // ---------- PDF extractors ----------
    async function pdfToTextLines(file){
      const ab = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({data:ab}).promise;
      const lines=[]; let full='';

      for(let p=1;p<=pdf.numPages;p++){
        const page = await pdf.getPage(p);
        const txt = await page.getTextContent({normalizeWhitespace:true,disableCombineTextItems:false});
        const buckets = new Map();
        for(const it of txt.items){
          const y = Math.round(it.transform[5]);
          const x = Math.round(it.transform[4]);
          const arr = buckets.get(y) || [];
          arr.push({x,str:it.str}); buckets.set(y,arr);
        }
        const ys = Array.from(buckets.keys()).sort((a,b)=>b-a);
        for(const y of ys){
          const arr=buckets.get(y).sort((a,b)=>a.x-b.x);
          const line = arr.map(o=>o.str).join(' ').replace(/\s{2,}/g,' ').trim();
          if(line){ lines.push(line); full += line+'\n'; }
        }
        lines.push(''); full+='\n';
      }
      return {lines, fullText:full};
    }

    async function pdfToOCRText(file, maxPages=5){
      const ab = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({data:ab}).promise;
      let full=''; const lines=[];
      const worker = Tesseract.createWorker();
      await worker.load(); await worker.loadLanguage('por'); await worker.initialize('por');

      for(let p=1;p<=pdf.numPages && p<=maxPages;p++){
        const page = await pdf.getPage(p);
        const viewport = page.getViewport({scale:2});
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({canvasContext:ctx, viewport}).promise;
        const { data: { text } } = await worker.recognize(canvas);
        const t = (text||'').replace(/[ \t]+/g,' ').trim();
        if(t){ full += t+'\n'; t.split(/\r?\n/).forEach(s=>{ s=s.trim(); if(s) lines.push(s); }); }
      }
      await worker.terminate();
      return {lines, fullText:full};
    }

    // ---------- Parsers ----------
    function parseStone(lines, venc, conta, centro){
      const res=[];
      const text = lines.join('\n');
      const sec = text.match(/LANÇAMENTOS DA FATURA[\s\S]*?(?=ENCARGOS|OBRIGAÇÕES|FATURA EM ATRASO|$)/i);
      if (!sec) return res;
      const ls = sec[0].split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const ano = anoFromVencimento();

      for(let i=0;i<ls.length;i++){
        const d = ls[i].match(/^(\d{1,2})\s+(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)\b/i);
        if(!d) continue;
        const dd = d[1].padStart(2,'0');
        const mm = MESES[d[2].toLowerCase()]||'01';
        const dataComp = `${dd}/${mm}/${ano}`;

        let desc = ls[i].replace(d[0],'').trim();
        if(i+1<ls.length && /Parcela\s+\d+\s+de\s+\d+/i.test(ls[i+1])){ desc = (desc?desc+' ':'') + ls[i+1]; i++; }

        let valorStr=null;
        const vm0 = ls[i].match(/R\$\s*([\d\.\,]+)$/); if(vm0) valorStr=vm0[1];
        if(!valorStr && i+1<ls.length){ const vm1=ls[i+1].match(/R\$\s*([\d\.\,]+)$/); if(vm1){valorStr=vm1[1]; i++;} }
        if(!valorStr) continue;

        const valor = toNegBR(valorStr);
        res.push(rowCA(dataComp, venc, valor, getCategoria(desc||'(sem descrição)'), (desc||'(sem descrição)').replace(/\s{2,}/g,' ').trim(), conta, centro));
      }
      return res;
    }

    function parseSantander(lines, venc, conta, centro){
      const res=[]; let inBlock=false;
      const blacklist = [/VALORES EM REAIS/i,/Pagamento de fatura/i,/Pagamento feito/i,/Total em R\$/i,/Total desta fatura/i];
      for(const raw of lines){
        const l = raw.trim();
        if(/Trans[aã]coes?\s+Nacionais/i.test(l)){ inBlock=true; continue; }
        if(inBlock && /(Total em R\$|Total desta fatura)/i.test(l)) break;
        if(!inBlock) continue;

        const m = l.match(/(\d{2}-\d{2}-\d{4})\s+(.+?)\s+([\d\.\,]+)$/);
        if(!m) continue;

        const desc = m[2].replace(/\s{2,}/g,' ').trim();
        if(blacklist.some(rx=>rx.test(desc))) continue;

        const data = m[1].replace(/-/g,'/');
        const valor = toNegBR(m[3]);
        res.push(rowCA(data, venc, valor, getCategoria(desc), desc, conta, centro));
      }
      return res;
    }

    // ---------- State/UI ----------
    let rawText=''; let lines=[]; let rows=[];

    $('file').addEventListener('change', async (ev)=>{
      hideAlert(); rows=[]; renderTable([]);
      const f = ev.target.files[0]; if(!f) return;
      $('fileName').textContent = `Arquivo: ${f.name}`;
      try{
        if(f.type==='application/pdf' || /\.pdf$/i.test(f.name)){
          let extracted = await pdfToTextLines(f);
          if($('forceOcr').checked || !/\w{3,}/.test(extracted.fullText)){
            extracted = await pdfToOCRText(f, 5);
          }
          lines = extracted.lines; rawText = extracted.fullText;
        }else{
          const txt = await f.text(); rawText = txt; lines = txt.split(/\r?\n/).map(s=>s.trim());
        }
        $('debug').value = rawText;
        const autoVenc = detectVencimento(rawText); if(autoVenc) $('venc').value = autoVenc;
        $('conta').value = detectConta(rawText);
        showAlert('Arquivo carregado. Confira vencimento/conta e clique em “Processar Fatura”.','ok');
      }catch(e){ console.error(e); showAlert('Erro ao ler o arquivo: '+e.message,'error'); }
    });

    $('processBtn').addEventListener('click', ()=>{
      hideAlert(); rows=[]; renderTable([]);
      if(!rawText){ showAlert('Envie a fatura (PDF/TXT) antes de processar.','error'); return; }
      const venc = $('venc').value.trim();
      if(!/^\d{2}\/\d{2}\/\d{4}$/.test(venc)){ showAlert('Informe a Data de Vencimento no formato dd/mm/aaaa.','error'); return; }
      const conta = $('conta').value;
      const centro = $('centro').value.trim()||'Café';

      let parsed=[];
      if(/stone/i.test(conta)) parsed = parseStone(lines, venc, conta, centro);
      else if(/santander/i.test(conta)) parsed = parseSantander(lines, venc, conta, centro);
      else {
        const auto = detectConta(rawText); $('conta').value = auto;
        parsed = /stone/i.test(auto) ? parseStone(lines, venc, auto, centro) : parseSantander(lines, venc, auto, centro);
      }

      if(!parsed.length){ showAlert('Nenhum lançamento identificado. Se a fatura for escaneada, marque “Forçar OCR”. Veja o texto extraído (debug).','error'); $('exportBtn').disabled = true; return; }
      rows = parsed; renderTable(rows); $('exportBtn').disabled = false;
      showAlert(`${rows.length} lançamento(s) identificado(s). Revise e exporte o CSV.`,'ok');
    });

    $('exportBtn').addEventListener('click', ()=>{
      if(!rows.length){ showAlert('Nada para exportar.','error'); return; }
      const csv = ['\ufeff'+HEADERS.join(';')]
        .concat(rows.map(r=>HEADERS.map(h=>quoteCSV(r[h]??'')).join(';')))
        .join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      a.download=`importacao_conta_azul_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    });

    function renderTable(items){
      const tbody = $('tbody'); tbody.innerHTML='';
      $('countTag').textContent = `${items.length} lançamento${items.length===1?'':'s'}`;
      for(const r of items){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 text-xs">${r['Data de Competência']}</td>
          <td class="px-3 py-2 text-xs">${escapeHTML(r['Descrição']).slice(0,200)}</td>
          <td class="px-3 py-2 text-xs">${r['Categoria']}</td>
          <td class="px-3 py-2 text-xs text-right">${r['Valor']}</td>`;
        tbody.appendChild(tr);
      }
    }
    function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
  })();
  </script>
</body>
</html>




