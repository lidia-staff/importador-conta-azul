<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Importador de Faturas → CSV Conta Azul (com OCR)</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>.mono{font-family:ui-monospace,Consolas,Menlo,monospace}</style>
</head>
<body class="bg-slate-50 text-slate-800">
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-2xl md:text-3xl font-bold mb-1">Importador de Faturas → CSV do Conta Azul</h1>
  <p class="text-sm text-slate-600 mb-6">Stone (com OCR automático) e Santander. CSV com 10 colunas padrão Conta Azul.</p>

  <div id="alert" class="hidden mb-4 p-3 rounded-lg border text-sm"></div>

  <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">1) Fatura (PDF ou TXT)</label>
        <input id="file" type="file" accept=".pdf,.txt"
               class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200"/>
        <p id="fileName" class="text-xs text-slate-500 mt-1"></p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">2) Data de Vencimento (dd/mm/aaaa)</label>
        <input id="venc" type="text" placeholder="dd/mm/aaaa"
               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200"/>
        <p class="text-xs text-slate-500 mt-1">O <b>ano</b> desta data será aplicado às compras.</p>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">3) Conta (Conta Azul)</label>
        <select id="conta" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200">
          <option>Cartão de Crédito Stone</option>
          <option>Cartão de Crédito Santander</option>
        </select>
        <label class="inline-flex items-center gap-2 text-sm mt-2">
          <input id="forceOCR" type="checkbox" class="rounded border-slate-300">
          <span>Forçar OCR (para Stone escaneada)</span>
        </label>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">4) Centro de Custo</label>
        <input id="centro" type="text" value="Café"
               class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:ring-indigo-200"/>
      </div>
    </div>
    <div class="mt-4 flex gap-3 flex-wrap">
      <button id="processBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
        Processar Fatura
      </button>
      <button id="exportBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" disabled>
        Exportar CSV
      </button>
    </div>
  </div>

  <div class="bg-white rounded-xl shadow-sm p-5 mb-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold">Pré-visualização</h2>
      <span id="countTag" class="text-xs px-2 py-1 rounded-full bg-slate-100">0 lançamentos</span>
    </div>
    <div class="overflow-auto border rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left px-3 py-2">Competência</th>
            <th class="text-left px-3 py-2">Descrição</th>
            <th class="text-left px-3 py-2">Categoria</th>
            <th class="text-right px-3 py-2">Valor (R$)</th>
          </tr>
        </thead>
        <tbody id="tbody" class="divide-y"></tbody>
      </table>
    </div>
    <p class="text-xs text-slate-500 mt-2">O CSV final contém as 10 colunas exigidas pelo Conta Azul.</p>
  </div>

  <details class="bg-white rounded-xl shadow-sm p-5">
    <summary class="cursor-pointer font-medium">Texto extraído (debug)</summary>
    <textarea id="debug" class="w-full h-56 mt-3 p-2 border rounded-lg mono text-xs"></textarea>
  </details>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const alertBox=$('alert');
  const isFileProto = location.protocol==='file:';
  if(isFileProto){
    showAlert('Este arquivo foi aberto por "file://". Para OCR e leitura confiável de PDFs, abra em http(s) — ex.: publique em GitHub Pages ou use http://localhost.', 'info');
  }

  function showAlert(msg,type='info'){
    alertBox.className='mb-4 p-3 rounded-lg border text-sm';
    const map={error:'border-red-300 bg-red-50 text-red-800',success:'border-emerald-300 bg-emerald-50 text-emerald-800',info:'border-slate-300 bg-slate-50 text-slate-800'};
    map[type].split(' ').forEach(c=>alertBox.classList.add(c));
    alertBox.textContent=msg; alertBox.classList.remove('hidden');
  }
  function hideAlert(){ alertBox.classList.add('hidden'); }

  const MESES={jan:'01',fev:'02',mar:'03',abr:'04',mai:'05',jun:'06',jul:'07',ago:'08',set:'09',out:'10',nov:'11',dez:'12'};
  function normalize(s){return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}
  const CATS={seguro:'Seguro de Imóveis',canva:'Software / Licença de Uso',google:'Software / Licença de Uso',gsuite:'Software / Licença de Uso',magalu:'Eletrodomésticos',geladeira:'Eletrodomésticos',leroy:'Despesas a identificar',mercadolivre:'Despesas a identificar',default:'Despesas a identificar'};
  function categoria(desc){const n=normalize(desc);for(const k in CATS){if(k!=='default'&&n.includes(k))return CATS[k]}return CATS.default}
  function toNegBR(str){const c=String(str).replace(/R\s*\$/,'').replace(/\s/g,'').replace(/\./g,'').replace(',', '.');const v=parseFloat(c);return -Math.abs(isFinite(v)?v:0)}
  function fmtBR(n){return (n<0?'-':'')+Math.abs(n).toFixed(2).replace('.',',')}
  function quoteCSV(v){const s=String(v??'');return (/[;"\n]/.test(s))?`"${s.replace(/"/g,'""')}"`:s}

  function rowCA(dataComp,venc,valor,categ,desc,centro){
    const cc=(centro||'Café').replace(/^cafe$/i,'Café');
    return {
      'Data de Competência':dataComp,
      'Data de Vencimento':venc,
      'Data de Pagamento':'',
      'Valor':fmtBR(valor),
      'Categoria':categ,
      'Descrição':desc,
      'Cliente/Fornecedor':'',
      'CNPJ/CPF Cliente/Fornecedor':'',
      'Centro de Custo':cc,
      'Observações':''
    };
  }

  function detectVenc(text){
    let m=text.match(/VENCE\s+EM\s+(\d{2})\s+(JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ)\s+(\d{4})/i);
    if(m){const mm=MESES[m[2].toLowerCase()]||'01';return `${m[1]}/${mm}/${m[3]}`}
    m=text.match(/Vencimento[^0-9]+(\d{2}\/\d{2}\/\d{4})/i);return m?m[1]:''
  }
  function detectConta(text){if(/stone/i.test(text))return'Cartão de Crédito Stone';if(/santander/i.test(text))return'Cartão de Crédito Santander';return $('conta').value}

  async function pdfToLines(file){
    const ab=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:ab, disableWorker:true}).promise;
    const lines=[];
    for(let p=1;p<=pdf.numPages;p++){
      const page=await pdf.getPage(p);
      const c=await page.getTextContent({normalizeWhitespace:true,disableCombineTextItems:false});
      const buckets=new Map();
      for(const it of c.items){
        const y=Math.round(it.transform[5]); const x=Math.round(it.transform[4]);
        (buckets.get(y)||buckets.set(y,[]).get(y)).push({x,str:it.str});
      }
      const ys=[...buckets.keys()].sort((a,b)=>b-a);
      for(const y of ys){
        const line=buckets.get(y).sort((a,b)=>a.x-b.x).map(o=>o.str).join(' ').replace(/\s{2,}/g,' ').trim();
        if(line) lines.push(line);
      }
      lines.push('');
    }
    return lines;
  }
  function txtToLines(t){return t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean)}

  async function ocrAllPages(){
    const f=$('file').files[0]; if(!f) return [];
    const ab=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:ab, disableWorker:true}).promise;
    const out=[];
    for(let p=1;p<=pdf.numPages;p++){
      const page=await pdf.getPage(p);
      const viewport=page.getViewport({scale:2});
      const canvas=document.createElement('canvas');
      canvas.width=viewport.width; canvas.height=viewport.height;
      await page.render({canvasContext:canvas.getContext('2d'),viewport}).promise;
      const r=await Tesseract.recognize(canvas,'por');
      out.push(...r.data.text.split(/\r?\n/).map(s=>s.trim()));
      out.push('');
    }
    return out;
  }

  function parseSantander(lines,venc,centro){
    const out=[];const skip=/(boleto|pagamento\s+da?\s+fatura|pagamento\s+de\s+fatura|pagamento\s+do\s+m[eê]s\s+anterior)/i;
    const re=/(\d{2}[\/-]\d{2}[\/-]\d{4})\s+(.+?)\s+([\d\.,]+)$/;
    for(const l of lines){
      const m=l.match(re); if(!m) continue;
      const data=m[1].replace(/-/g,'/'); const desc=m[2].replace(/\s{2,}/g,' ').trim(); if(skip.test(desc)) continue;
      const valor=toNegBR(m[3]); out.push(rowCA(data,venc,valor,categoria(desc),desc,centro));
    }
    return out;
  }

  function parseStone(lines, venc, centro){
  // 1) Normalizações e setup
  const start = lines.findIndex(l => /LANÇAMENTOS\s+DA\s+FATURA/i.test(l));
  const section = start >= 0 ? lines.slice(start) : lines.slice();

  // corrige artefatos comuns do OCR e padroniza valores
  const fix = s => s
    .replace(/^(\d{1,2})([a-z]{3})/i, '$1 $2')         // "1nov" -> "1 nov"
    .replace(/(\d{1,2})\s*2go/i, '$1 ago')             // "2go" -> "ago"
    .replace(/(\d{1,2})\s*06ut/i, '$1 out')            // "06ut" -> "out"
    .replace(/(\d{1,2})\s*1nov/i, '$1 nov')            // "1nov" -> "nov"
    .replace(/R\s*\$/g, 'R$');                         // "R $" -> "R$"

  const L = section.map(fix);
  const ano = venc.slice(-4);
  const out = [];

  // data "dd mmm"
  const reData = /^(\d{1,2})\s+(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)\b/i;
  // valor pode estar na mesma linha ou sem espaço após "R$"
  const reValor = /(?:R\$\s*|R\$)?(\d{1,3}(?:\.\d{3})*,\d{2})\b/;
  const reParc  = /Parcela\s+\d+\s+de\s+\d+/i;
  const ignorar=/(Pagamento\s+feito|ENCARGOS|OPÇÕES|RESUMO|OBRIGAÇÕES|TOTAL|DISPON[IÍ]VEL|SALDO|DATA\b|DESCRIÇÃO\b|VALOR\b)/i;

  for (let i=0; i<L.length; i++){
    let line = L[i];
    if (!line || ignorar.test(line)) continue;

    const mD = line.match(reData);
    if (!mD) continue; // só começa a ler quando acha uma data

    // monta data competência usando o ano do vencimento
    const dd = mD[1].padStart(2,'0');
    const mm = ( {jan:'01',fev:'02',mar:'03',abr:'04',mai:'05',jun:'06',jul:'07',ago:'08',set:'09',out:'10',nov:'11',dez:'12'} )[mD[2].toLowerCase()] || '01';
    const dataComp = `${dd}/${mm}/${ano}`;

    // tira a data da linha e começa a formar a descrição
    let desc = line.slice(mD.index + mD[0].length).replace(reValor,'').replace(/[—–-]\s*/,'').trim();
    if (reParc.test(L[i+1]||'')) desc = (desc + ' ' + (L[i+1]||'')).trim();

    // 2) procurar o valor: mesma linha OU nas 2 próximas
    let valorMatch = line.match(reValor) || (L[i+1] && L[i+1].match(reValor)) || (L[i+2] && L[i+2].match(reValor));
    if (!valorMatch){
      // se não achou, é provavelmente ruído de OCR → ignora este bloco
      continue;
    }

    const valor = toNegBR(valorMatch[1]);
    if (!desc) desc = '(sem descrição)';

    // proteção extra: pula linhas claramente não-transação
    if (ignorar.test(desc)) continue;

    out.push(rowCA(dataComp, venc, valor, categoria(desc), desc, centro));
  }
  return out;
}

  let rawText=''; let lines=[]; let rows=[];
  $('file').addEventListener('change',async (ev)=>{
    hideAlert(); rows=[]; render([]); $('exportBtn').disabled=true;
    const f=ev.target.files[0]; if(!f) return;
    $('fileName').textContent=`Arquivo: ${f.name}`;
    try{
      if(f.type==='application/pdf'||f.name.toLowerCase().endsWith('.pdf')){
        lines=await pdfToLines(f); rawText=(lines||[]).join('\n');
      }else{
        const txt=await f.text(); rawText=txt; lines=txtToLines(txt);
      }
      const autoV=detectVenc(rawText); if(autoV) $('venc').value=autoV;
      $('conta').value=detectConta(rawText);
      $('debug').value=rawText.slice(0,4000);
      showAlert('Arquivo carregado. Para Stone em imagem, marque “Forçar OCR” e processe.', 'success');
    }catch(e){console.error(e);showAlert('Erro ao ler arquivo: '+e.message,'error')}
  });

  $('processBtn').addEventListener('click',async ()=>{
    hideAlert(); rows=[]; render([]); $('exportBtn').disabled=true;
    const venc=$('venc').value.trim(); const conta=$('conta').value; const centro=$('centro').value.trim()||'Café';
    if(!/^\d{2}\/\d{2}\/\d{4}$/.test(venc)){showAlert('Informe a Data de Vencimento (dd/mm/aaaa).','error');return}
    if(!$('file').files[0]){showAlert('Envie a fatura primeiro.','error');return}

    let parsed=[];
    if(/santander/i.test(conta)){
      parsed=parseSantander(lines||[],venc,centro);
    }else{
      parsed=parseStone(lines||[],venc,centro);
      if($('forceOCR').checked || parsed.length<3){
        if(isFileProto){ showAlert('Para executar o OCR, abra esta página via http(s) (ex.: GitHub Pages ou http://localhost).', 'error'); return; }
        showAlert('Executando OCR (pode levar alguns segundos)…','info');
        try{
          const ocrLines=await ocrAllPages();
          $('debug').value=ocrLines.join('\n').slice(0,4000);
          parsed=parseStone(ocrLines,venc,centro);
        }catch(e){console.error(e); showAlert('Falha no OCR: '+e.message,'error');}
      }
    }

    if(!parsed.length){showAlert('Nenhum lançamento identificado.', 'error'); return;}
    rows=parsed; render(rows); $('exportBtn').disabled=false;
    showAlert(`${rows.length} lançamentos identificados. Revise e exporte o CSV.`,'success');
  });

  $('exportBtn').addEventListener('click',()=>{
    if(!rows.length) return;
    const HEAD=['Data de Competência','Data de Vencimento','Data de Pagamento','Valor','Categoria','Descrição','Cliente/Fornecedor','CNPJ/CPF Cliente/Fornecedor','Centro de Custo','Observações'];
    const csv=['\ufeff'+HEAD.join(';')];
    for(const r of rows){csv.push(HEAD.map(h=>quoteCSV(r[h]||'')).join(';'))}
    const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='importacao_conta_azul_'+new Date().toISOString().slice(0,10).replace(/-/g,'')+'.csv';
    document.body.appendChild(a); a.click(); a.remove();
  });

  function render(items){
    $('countTag').textContent=`${items.length} lançamento${items.length===1?'':'s'}`;
    const tb=$('tbody'); tb.innerHTML='';
    for(const r of items){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td class="px-3 py-2 text-xs">${r['Data de Competência']}</td>
        <td class="px-3 py-2 text-xs">${escapeHTML(r['Descrição']).slice(0,220)}</td>
        <td class="px-3 py-2 text-xs">${r['Categoria']}</td>
        <td class="px-3 py-2 text-xs text-right">${r['Valor']}</td>`;
      tb.appendChild(tr);
    }
  }
  function escapeHTML(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
})();
</script>
</body>

</html>
